<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aturan â€¢ Reveal Quiz</title>
  <style>
    :root{
      --panel:#d9d9d9;
      --stroke:#222;
      --text:#111;
      --muted:rgba(0,0,0,.68);

      --roundBig:28px;
      --round:22px;
      --w: 980px;
    }

    *{box-sizing:border-box;font-family:system-ui,Arial,sans-serif}
    body{margin:0;background:#fff;color:var(--text)}
    .page{max-width:var(--w);margin:0 auto;padding:26px}

    .stack{
      min-height:calc(100vh - 52px);
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:22px;
      align-items:center;
    }

    .ruleCard{
      width:min(900px, 92vw);
      height:340px;
      background:var(--panel);
      border:2px solid var(--stroke);
      border-radius:var(--roundBig);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:30px;
      text-align:center;
    }

    .ruleTitle{
      font-size:30px;
      font-weight:900;
      margin:0 0 14px;
      letter-spacing:.2px;
    }

    .ruleText{
      margin:0;
      max-width:760px;
      color:var(--muted);
      font-weight:700;
      line-height:1.75;
      font-size:16px;
    }
    .ruleText .line{display:block;margin:4px 0;}

    .loadingCard{
      width:min(900px, 92vw);
      height:120px;
      background:var(--panel);
      border:2px solid var(--stroke);
      border-radius:var(--roundBig);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px 24px;
      gap:14px;
      flex-direction:column;
    }

    .barShell{
      width:min(760px, 100%);
      height:24px;
      border:2px solid var(--stroke);
      border-radius:999px;
      overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.18));
      box-shadow:inset 0 2px 0 rgba(255,255,255,.55), inset 0 -2px 0 rgba(0,0,0,.08);
      position:relative;
    }

    .barFill{
      height:100%;
      width:0%;
      border-radius:999px;
      background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.10));
      box-shadow:inset 0 2px 0 rgba(255,255,255,.35), 0 6px 14px rgba(0,0,0,.12);
      transition:width .14s linear;
    }

    .barFill::after{
      content:"";
      position:absolute;
      left:0; top:0;
      height:50%;
      width:100%;
      background:linear-gradient(90deg, rgba(255,255,255,.35), rgba(255,255,255,0));
      opacity:.55;
      pointer-events:none;
    }

    .btnRow{
      width:min(900px, 92vw);
      display:flex;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      margin-top:2px;
    }

    .btn{
      background:var(--panel);
      border:2px solid var(--stroke);
      border-radius:var(--round);
      padding:12px 16px;
      font-weight:900;
      cursor:pointer;
      min-width:180px;
      text-align:center;
      user-select:none;
    }
    .btn:hover{filter:brightness(.98)}
    .btn:disabled{opacity:.55; cursor:not-allowed;}
  </style>
</head>
<body>
  <main class="page">
    <section class="stack">

      <div class="ruleCard">
        <div>
          <h1 class="ruleTitle">Aturan Game</h1>

          <p class="ruleText">
            <span class="line">Jawab soal pakai keypad (maksimal 3 digit).</span>
            <span class="line">Jika salah 3 kali, tombol Hint akan aktif.</span>
            <span class="line">Setiap jawaban benar akan membuka 1 tile.</span>
            <span class="line">Fase 1 (2Ã—2) : timer 20 detik.</span>
            <span class="line">Fase 2 (3Ã—3) : timer 15 detik.</span>
            <span class="line">Fase 3 (4Ã—4) : timer 10 detik.</span>
            <span class="line">Jika tidak ada interaksi/timer habis, anda akan ditampilkan popup keluar.</span>
          </p>
        </div>
      </div>

      <div class="loadingCard">
        <div class="barShell" aria-label="Loading progress">
          <div id="barFill" class="barFill"></div>
        </div>
      </div>

      <div class="btnRow">
        <button class="btn" id="btnBack" type="button">Kembali</button>
        <button class="btn" id="btnContinue" type="button" disabled>Lanjutkan</button>
      </div>

    </section>
  </main>

  <!-- ðŸŽµ BGM -->
  <audio id="bgm" loop preload="auto">
    <source src="assets/audio/mathreveal.mp3" type="audio/mpeg">
  </audio>

  <script>
    const DURATION_SEC = 20;
    const NEXT_PAGE = "HalLevel.html";
    const BACK_PAGE = "menu.html";

    const barFill = document.getElementById("barFill");
    const btnBack = document.getElementById("btnBack");
    const btnContinue = document.getElementById("btnContinue");

    const bgm = document.getElementById("bgm");

    let tickId = null;
    let finished = false;

    function persistTime(){
      try{ sessionStorage.setItem("bgmTime", String(bgm.currentTime || 0)); }catch(_){}
    }

    // coba lanjutkan musik kalau boleh (kalau ke-block, nanti dipaksa lewat gesture tombol lanjutkan)
    function resumeBgmSoft(){
      if (localStorage.getItem("bgmUnlocked") !== "1") return;

      const t = Number(sessionStorage.getItem("bgmTime") || "0");
      if (Number.isFinite(t) && t > 0){
        try{ bgm.currentTime = t; }catch(_){}
      }

      bgm.volume = 0.4;
      bgm.play().catch(()=>{});
    }

    resumeBgmSoft();
    window.addEventListener("pagehide", persistTime);

    function goNext(){
      persistTime();
      window.location.href = NEXT_PAGE;
    }

    function start(){
      const startAt = Date.now();
      const totalMs = DURATION_SEC * 1000;

      barFill.style.width = "0%";
      btnContinue.disabled = true;
      finished = false;

      if (tickId) clearInterval(tickId);

      tickId = setInterval(() => {
        const elapsed = Date.now() - startAt;
        const ratio = Math.min(1, elapsed / totalMs);
        barFill.style.width = Math.floor(ratio * 100) + "%";

        if (ratio >= 1){
          clearInterval(tickId);
          finished = true;
          btnContinue.disabled = false;   // âœ… baru aktif setelah penuh
        }
      }, 100);
    }

    btnBack.addEventListener("click", () => {
      if (tickId) clearInterval(tickId);
      persistTime();
      window.location.href = BACK_PAGE;
    });

    btnContinue.addEventListener("click", () => {
      if (!finished) return; // extra safety

      // âœ… gesture user: pastikan musik hidup
      if (localStorage.getItem("bgmUnlocked") === "1"){
        bgm.volume = 0.4;
        bgm.play().catch(()=>{});
      }

      setTimeout(goNext, 120);
    });

    start();
  </script>
</body>
</html>
